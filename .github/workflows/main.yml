name: Notify Lark on Iconfont Changes

on:
  push:
    branches:
      - 'release/**'
    paths:
      - 'src/action/iconfont*'
  pull_request:
    types: [closed]
    branches:
      - 'release/**'
    paths:
      - 'src/action/iconfont*'

jobs:
  notify-lark:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get changed iconfont files
        id: changes
        run: |
          git fetch --depth=2
          CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^src/action/iconfont' || true)
          if [ -n "$CHANGED" ]; then
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          else
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          fi

      - name: Send notification to Lark
        if: env.HAS_CHANGES == 'true'
        run: |
          curl -X POST "$LARK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "ğŸ¯ iconfont ç›®å½•æœ‰å˜æ›´\nåˆ†æ”¯ï¼š${{ github.ref_name }}\næäº¤äººï¼š${{ github.actor }}\næäº¤ä¿¡æ¯ï¼š${{ github.event.head_commit.message }}"
              }
            }'
        env:
          LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
